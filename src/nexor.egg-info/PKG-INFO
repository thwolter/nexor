Metadata-Version: 2.4
Name: nexor
Version: 0.6.0
Summary: Shared database and configuration helpers for the FDE services
Author-email: FDE Team <support@riskary.de>
License: MIT
Requires-Python: >=3.13
Description-Content-Type: text/markdown
Requires-Dist: asyncpg>=0.27.0
Requires-Dist: greenlet>=3.2.3
Requires-Dist: sqlmodel>=0.0.27
Requires-Dist: sqlalchemy>=2.0.18
Requires-Dist: pydantic>=2.5.0
Requires-Dist: pydantic-settings>=2.11.0
Requires-Dist: tenauth@ git+https://github.com/thwolter/fde-tenauth.git@main
Requires-Dist: loguru>=0.7.3
Requires-Dist: opentelemetry-instrumentation-openai>=0.49.6
Requires-Dist: opentelemetry-api>=1.38.0
Requires-Dist: opentelemetry-sdk>=1.38.0
Requires-Dist: opentelemetry-exporter-otlp-proto-http>=1.38.0

# Nexor

Reusable configuration and database helpers for the FDE services.

## Goals
- Centralize the async SQLAlchemy/SQLModel engine, session, and `asyncpg` helpers so every service can share the same connection lifecycle.
- Provide a lightweight `ServiceSettings` base plus the `ValidatedSettings`/`ValidatedModel` helpers so each service uses consistent validation for environment variables.
- Provide shared logging and observability helpers (`nexor.logging.configure_loguru_logging`, `nexor.logging.configure_std_logging`, `nexor.observability.*`) so every service uses consistent console sinks, OTLP exporters, and resource attributes.

## Installation
Install the package via a path dependency (see harvestor `pyproject.toml` for an example):

```bash
pip install -e ../nexor
```

or add `nexor @ file://../nexor` to your project's `[project].dependencies`.

## Usage
### Shared configuration
Customize your service settings by inheriting from `nexor.config.ServiceSettings` (exported as `ServiceSettings` for backward compatibility). Each instance exposes a `.db` attribute backed by `NexorDBSettings`, so database helpers receive a focused configuration object:

```python
from pydantic import Field, SecretStr

from nexor.config import NexorDBSettings, ServiceSettings


class Settings(ServiceSettings):
    required_keys = ['redis_url', 'openai_api_key']
    debug: bool | None = None
    redis_url: SecretStr | None = None
    db: NexorDBSettings = Field(default_factory=lambda: NexorDBSettings(app_schema='my-service'))
```

`nexor.config` also exports `normalize_postgres_url` so each service can canonicalize a URL once per process. `Settings.db` provides `async_postgres_url`, `migration_url`, pooling knobs, and schema defaults that every service shares.

### Database helpers
Call the shared session helpers with your service settings:

```python
from nexor.infrastructure import db
from config import get_settings

get_engine = db.get_engine(get_settings().db)

async with db.session_factory(get_settings().db) as session:
    ...
```

Use `db.scoped_session(db_settings=settings.db, access_context=access)` when tenant-scoped sessions are required, and leverage `db.test_db_connection(settings.db)` during startup health checks.
